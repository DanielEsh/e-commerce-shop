import React, { useState } from "react";
import { Link, Redirect } from 'react-router-dom';
import {useAuth} from 'components/User/context'
import { Card, Form, Input, Button, Error } from 'components/User/auth';


function Login() {
    const [isLoggedIn, setLoggedIn] = useState(false);
    const [isError, setIsError] = useState(false);
    const [userName, setUserName] = useState("");
    const [password, setPassword] = useState("");
    const { setAuthTokens } = useAuth();

    function validJWT() {
        const request2 = new XMLHttpRequest();
        request2.open('POST', 'https://telephone.su/api/users/validate_token.php');
        let obj2 = {}
        obj2['jwt'] = JSON.parse(localStorage.getItem('tokens'))
        request2.send(JSON.stringify(obj2));
        request2.onload = () => {
            let a = JSON.parse(request2.response)
            console.log(a)
            localStorage.setItem('user', JSON.stringify(a.data) )
        }
    }
    function postLogin(e) {
        e.preventDefault()
        const request = new XMLHttpRequest();
        request.open('POST', 'https://telephone.su/api/users/login.php');
        let obj = {}
        obj['email'] = userName;
        obj['password'] = password;
        console.log(obj)
        request.responseType = 'json';
        request.send(JSON.stringify(obj));
        request.onload = () => {
            console.log(request.response.jwt);// token
            if (request.status === 200){
                setAuthTokens(request.response.jwt)
                setLoggedIn(true);
            } else {
                setIsError(true);
            }
        }
    }
    if (isLoggedIn) {
        validJWT()
        // return <Redirect to="/"/>;
        return window.location.pathname = '/'
    }

    return (
        <Card>
            <h2>Авторизация</h2>
            <Form onSubmit={postLogin}>
                <Input
                    type="username"
                    value={userName}
                    onChange={e => {
                        setUserName(e.target.value);
                    }}
                    placeholder="email"
                />
                <Input
                    type="password"
                    value={password}
                    onChange={e => {
                        setPassword(e.target.value);
                    }}
                    placeholder="пароль"
                />
                <Button onClick={postLogin}>Войти</Button>
            </Form>
            { isError &&<Error>Логин или пароль введен не верно!</Error> }
            <Link to="/">Вернуться на главную</Link>
            <Link to="/signup">Нет аккаунта? Нажмите что бы зарегистрироваться</Link>


        </Card>

    );
}

export default Login;