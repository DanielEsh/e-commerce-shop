import React, {useState} from "react";
import {useAuth} from 'components/User/context'
import {Link} from "react-router-dom";

import Header from 'components/header'
import TopHeader from 'components/header/top-header'
import Subscribe from 'components/subscribe'
import Footer from 'components/footer'

function Admin(props) {
    let [data] = useState("")
    data = JSON.parse(localStorage.getItem('user'))
    console.log('data', data)
    const {setAuthTokens} = useAuth();
    // const [isError, setIsError] = useState(false);
    const [name, setName] = useState('');
    const [password, setPassword] = useState("");
    const [email, setEmail] = useState('');


    function logOut() {
        setAuthTokens('');
        localStorage.removeItem('user')
    }

    const validJWT = () => {
        const request = new XMLHttpRequest();
        request.open('POST', 'https://telephone.su/api/users/validate_token.php');
        let obj = {}
        obj['jwt'] = JSON.parse(localStorage.getItem('tokens'))
        request.send(JSON.stringify(obj));
        request.onload = () => {
            let a = JSON.parse(request.response)
            data = localStorage.setItem('user', JSON.stringify(a.data))
            return data
        }
        console.log('return', data)
    }
    const handleSubmit = (e) => {
        e.preventDefault()
        const request = new XMLHttpRequest();
        request.open('POST', 'https://telephone.su/api/users/update_user.php');
        let obj = {}
        obj['name'] = name;
        obj['email'] = email;
        obj['password'] = password;
        obj['jwt'] = JSON.parse(localStorage.getItem('tokens'))
        console.log(obj)
        request.responseType = 'json';
        request.send(JSON.stringify(obj));
        request.onload = () => {
            console.log(request.response);// ответ
        }
        request.addEventListener('readystatechange', () => {
            document.querySelector('.info').innerHTML = 'Данные успешно обновленны, перезайдите в личный кабинет'
        });
    }


    return (
        <div>
            <TopHeader/>
            <Header/>
            <div className='container profile'>
                    {document.addEventListener('window.onload', validJWT())}
                    <div>
                        <h2>Личный кабинет</h2>
                        <p>Добро пожаловать, <span>{data.name}</span></p>
                    </div>

                    <div className='col-md-6'>
                        <div className='profile well'>
                            <h3>Смена данных</h3>
                            <form method='POST' onSubmit={handleSubmit}>
                                <label htmlFor='nameEdit'>Введите новое имя:</label>
                                <input name='name' type='name' id='nameEdit'
                                       value={name}
                                       onChange={e => {
                                           setName(e.target.value);
                                       }}
                                       placeholder={data.name}
                                />
                                <label htmlFor='emailEdit'>Введите новый email:</label>
                                <input name='email' type='name' id='emailEdit'
                                       value={email}
                                       onChange={e => {
                                           setEmail(e.target.value);
                                       }}
                                       placeholder={data.email}
                                />

                                <label htmlFor='passwordEdit'>Введите новый пароль:</label>
                                <input name='password' type='password' id='passwordEdit'
                                       value={password}
                                       onChange={e => {
                                           setPassword(e.target.value);
                                       }}
                                       placeholder=""
                                />

                                <label htmlFor='passwordConfirmEdit'>Подтвердите новый пароль:</label>
                                <input name='passwordConfirm' type='password' id='passwordConfirmEdit'/>

                                <button type='submit' className='btn btn-red'>Изменить данные</button>
                                <div className='info'>

                                </div>
                            </form>

                        </div>

                        <div className='buttons'>
                            <Link to='/' onClick={logOut}>
                                Выйти
                            </Link>

                            <Link to='/' className='btn btn-red'>
                                Вернуться на главную
                            </Link>
                        </div>

                    </div>



            </div>
            <Subscribe/>
            <Footer/>
        </div>
    );
}

export default Admin;